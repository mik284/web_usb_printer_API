<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wi-Fi Printer</title>
</head>

<body>
    <h1>Wi-Fi Printer</h1>

    <div>
        <label for="printer-list">Available Printers:</label>
        <select id="printer-list">
            <option value="" disabled selected>Select a printer</option>
            <option value="192.168.100.89">Printer 1 (192.168.100.89)</option>
            <option value="192.168.100.1">Printer 2 (192.168.100.1)</option>
            <option value="manual">Enter IP Manually</option>
        </select>
        <div id="manual-input" style="display: none;">
            <input type="text" id="printer-ip" placeholder="Enter Printer IP Address">
        </div>
        <button id="connect">Connect to Printer</button>
        <button id="print" disabled>Print Test Page</button>
    </div>

    <p id="status">Not connected</p>

<script>
    let ws;
    let connected = false;

    const connectButton = document.getElementById('connect');
    const printButton = document.getElementById('print');
    const statusElement = document.getElementById('status');
    const printerList = document.getElementById('printer-list');
    const printerIPInput = document.getElementById('printer-ip');
    const manualInputDiv = document.getElementById('manual-input');

    printerList.addEventListener('change', (event) => {
        if (event.target.value === 'manual') {
            manualInputDiv.style.display = 'block';
        } else {
            manualInputDiv.style.display = 'none';
        }
    });

    connectButton.addEventListener('click', () => {
        let printerIP = printerList.value;

        if (printerIP === 'manual') {
            printerIP = printerIPInput.value;
        }

        if (!printerIP) {
            alert('Please select or enter a valid printer IP address.');
            return;
        }

        ws = new WebSocket('ws://localhost:8080');

        ws.onopen = () => {
            connected = true;
            statusElement.textContent = 'Connected to WebSocket server';
            statusElement.style.color = 'green';
            printButton.disabled = false;
        };

        ws.onerror = (error) => {
            console.error('WebSocket Error:', error);
            statusElement.textContent = 'Error connecting to WebSocket server';
            statusElement.style.color = 'red';
        };

        ws.onclose = () => {
            connected = false;
            statusElement.textContent = 'Disconnected from WebSocket server';
            statusElement.style.color = 'red';
            printButton.disabled = true;
        };
    });

    printButton.addEventListener('click', () => {
        if (!connected || !ws) {
            console.error('Not connected to WebSocket server');
            return;
        }

        // ESC/POS commands for printing "Hello, Wi-Fi Printer!"
        const ESC = '\x1B';  // ESC byte
        const LF = '\x0A';   // Line feed (new line)
        const printData = ESC + '!' + '\x00' + 'Hello, Wi-Fi Printer!' + LF + LF;

        const printerIP = printerList.value === 'manual' ? printerIPInput.value : printerList.value;

        // Send print data and printer IP to the Node.js server
        ws.send(JSON.stringify({ printerIP, data: printData }));
    });
</script>

</body>

</html>